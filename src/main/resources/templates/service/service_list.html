<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{fragments/layout}">
<head>
    <title>Nuestros Servicios - Essence De Toi</title>
    <script type="text/javascript" th:inline="javascript">
        /*<![CDATA[*/
        function updatePrice(serviceId) {
            console.log('Función updatePrice llamada con ID:', serviceId);
            
            const priceInput = document.getElementById('price-input-' + serviceId);
            console.log('Input encontrado:', priceInput);
            
            if (!priceInput) {
                console.error('No se encontró el input del precio');
                return;
            }
            
            const price = priceInput.value;
            console.log('Precio a actualizar:', price);
            
            if (!price || price <= 0) {
                alert('Por favor ingrese un precio válido');
                return;
            }
            
            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            
            console.log('Token:', token);
            console.log('Header:', header);
            
            const headers = {};
            headers[header] = token;
            headers['Content-Type'] = 'application/json';
            
            console.log('Headers:', headers);
            
            fetch('/services/update-price/' + serviceId + '?price=' + price, {
                method: 'POST',
                headers: headers,
                credentials: 'same-origin'
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Error al actualizar el precio');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Respuesta del servidor:', data);
                
                // Actualizar el precio mostrado
                const priceDisplay = document.querySelector('span[data-service-id="' + serviceId + '"]');
                if (priceDisplay) {
                    priceDisplay.textContent = new Intl.NumberFormat('es-CO', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    }).format(data.price);
                }
                
                // Actualizar el input
                if (priceInput) {
                    priceInput.value = data.price;
                }
                
                alert('Precio actualizado exitosamente');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            });
        }
        /*]]>*/
    </script>
</head>
<body>

<div layout:fragment="content" class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Nuestros Servicios</h2>
    </div>

    <div th:if="${services.isEmpty()}">
        <p>Actualmente no hay servicios disponibles. Por favor, vuelve a consultar más tarde.</p>
    </div>

    <div class="row" th:if="${!services.isEmpty()}">
        <div class="col-md-4 mb-4" th:each="service : ${services}">
            <div class="card h-100">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title" th:text="${service.name}">Nombre del Servicio</h5>
                    <p class="card-text flex-grow-1" th:text="${service.description}">Descripción del servicio.</p>
                    <ul class="list-unstyled mt-3 mb-4">
                        <li><strong>Duración:</strong> <span th:text="${service.durationMinutes}"></span> minutos</li>
                        <li class="d-flex align-items-center">
                            <strong class="me-2">Precio:</strong>
                            <span sec:authorize="!hasRole('ADMIN')" class="price-display">
                                COP $<span th:text="${#numbers.formatDecimal(service.price, 1, 'POINT', 2, 'COMMA')}" th:data-service-id="${service.id}"></span>
                            </span>
                            <div sec:authorize="hasRole('ADMIN')" class="d-flex align-items-center">
                                <div class="input-group" style="width: auto;">
                                    <span class="input-group-text">COP $</span>
                                    <input type="number" step="0.01" min="0"
                                           th:value="${service.price}"
                                           th:data-service-id="${service.id}"
                                           th:id="'price-input-' + ${service.id}"
                                           class="form-control form-control-sm price-input"
                                           style="width: 100px;"/>
                                    <button class="btn btn-sm btn-primary update-price-btn"
                                            type="button"
                                            th:data-service-id="${service.id}"
                                            th:onclick="'updatePrice(' + ${service.id} + ')'">Actualizar</button>
                                </div>
                            </div>
                        </li>
                    </ul>

                </div>
            </div>
        </div>
    </div>

    <!-- <div class="table-responsive" th:if="${!services.isEmpty()}">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Nombre</th>
                    <th>Descripción</th>
                    <th>Duración (min)</th>
                    <th>Precio</th>
                    <th sec:authorize="hasRole('ADMIN')">Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="service : ${services}">
                    <td th:text="${service.name}"></td>
                    <td th:text="${service.description}"></td>
                    <td th:text="${service.durationMinutes}"></td>
                    <td th:text="'COP $' + ${#numbers.formatDecimal(service.price, 1, 'POINT', 2, 'COMMA')}"></td>
                    <td sec:authorize="hasRole('ADMIN')">
                        <a th:href="@{/services/edit/{id}(id=${service.id})}" class="btn btn-sm btn-outline-primary">Editar</a>
                        <form th:action="@{/services/delete/{id}(id=${service.id})}" method="post" style="display: inline-block;" onsubmit="return confirm('¿Estás seguro de que deseas eliminar este servicio?');">
                            <button type="submit" class="btn btn-sm btn-outline-danger">Eliminar</button>
                        </form>
                    </td>
                </tr>
            </tbody>
        </table>
    </div> -->

</div>


</body>
</html>
